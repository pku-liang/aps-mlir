// Test 3: Mixed global scalars and arrays
// Tests: simultaneous handling of scalar and array globals

static scale_factor: u32 = 2;
static data: [u32; 8];

#[opcode(7'b0101011)]
#[funct7(7'b0000010)]
rtype scale_array(rs1: u5, rd: u5) {
    // Load array from CPU memory
    let addr: u32 = _irf[rs1];
    data[0 +: ] = _burst_read[addr +: 8];

    // Read scale factor
    let scale: u32 = scale_factor;

    // Scale each element
    with i: u32 = (0, i_) do {
        let val: u32 = data[i];
        let scaled: u32 = val * scale;
        data[i] = scaled;
        let i_: u32 = i + 1;
    } while (i_ < 8);

    // Update scale factor for next time
    let new_scale: u32 = scale + 1;
    scale_factor = new_scale;

    // Write back
    _burst_write[addr +: 8] = data[0 +: ];
    _irf[rd] = new_scale;
}
